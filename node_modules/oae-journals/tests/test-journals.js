/*!
 * Copyright 2014 Digital Services, University of Cambridge Licensed
 * under the Educational Community License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');
var util = require('util');

var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests/lib/util');

var JournalsRestAPI = require('../lib/test/util');

describe('Journals', function() {

    var anonymousCamRestContext = null;
    var anonymousGlobalRestContext = null;
    var camUserRestContext = null;
    var camAdminRestContext = null;
    var globalAdminRestContext = null;

    /**
     * Create rest contexts that can be used while running tests
     */
    before(function(callback) {
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        // Generate a Cambridge user
        TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, user) {
            camUserRestContext = user.restContext;
            callback();
        });
    });

    /**
     * Utility method that returns a stream that points to a CSV-file
     *
     * @return {Stream}     A stream that points to a CSV-file that can be uploaded
     */
    var getFileStream = function() {
        var file = __dirname + '/data/journals.csv';
        return fs.createReadStream(file);
    };

    describe('#importJournals()', function() {

        /**
         * Test that verifies that parameters are verified when importing journals
         */
        it('verify parameters', function(callback) {
            JournalsRestAPI.importJournals(globalAdminRestContext, null, function(err) {
                assert.equal(err.code, 400);

                JournalsRestAPI.importJournals(globalAdminRestContext, [], function(err) {
                    assert.equal(err.code, 400);

                    JournalsRestAPI.importJournals(globalAdminRestContext, {}, function(err) {
                        assert.equal(err.code, 400);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that only global administrators can import journals
         */
        it('verify permissions', function(callback) {
            JournalsRestAPI.importJournals(anonymousCamRestContext, {'journals': getFileStream}, function(err) {
                assert.equal(err.code, 404);

                JournalsRestAPI.importJournals(camUserRestContext, {'journals': getFileStream}, function(err) {
                    assert.equal(err.code, 404);

                    JournalsRestAPI.importJournals(camAdminRestContext, {'journals': getFileStream}, function(err) {
                        assert.equal(err.code, 404);

                        JournalsRestAPI.importJournals(anonymousGlobalRestContext, {'journals': getFileStream}, function(err) {
                            assert.equal(err.code, 401);

                            JournalsRestAPI.importJournals(globalAdminRestContext, {'journals': getFileStream}, function(err) {
                                assert.ok(!err);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that importing journals is successful
         */
        it('verify importing journals is successful', function(callback) {
            JournalsRestAPI.importJournals(globalAdminRestContext, {'journals': getFileStream}, function(err) {
                assert.ok(!err);

                SearchTestsUtil.searchRefreshed(camUserRestContext, 'journals', null, {'q': 'Soils'}, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.total);
                    assert.ok(_.isArray(data.results));
                    _.each(data.results, function(journal) {
                        assert.equal(journal.resourceType, 'journal');
                    });
                    return callback();
                });
            });
        });
    });
});
